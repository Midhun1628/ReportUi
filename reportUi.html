<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Report Layout Builder</title>
  <style>
    /* ← YOUR ORIGINAL STYLES ← */
   body { font-family: 'Segoe UI', sans-serif;
          margin: 0;
          display: flex;
          height: 100vh; }
          
   #sidebar {
  width: 260px;
  background: #34495e;
  color: white;
  padding: 20px;
  overflow-x: hidden;  /* <-- This hides horizontal scroll */
  overflow-y: auto;    /* <-- Still allows vertical scrolling */
  box-sizing: border-box;
}

    #sidebar h3 { 
    margin-top: 0; 
    font-size: 18px;
    border-bottom: 1px solid rgb(242 242 242 / 20%);
     }
    .draggable-label, button, select, input[type="color"] {
     width: 100%;
     padding: 10px; 
     margin: 6px 0;
     border: none;
     background: #2980b9;
     color: #fff;
     border-radius: 4px;
     cursor: pointer;

    }
    .draggable-label {
          background: #2c3f51;
          padding: 4px;
          margin-bottom: 10px;
          cursor: grab; 
          border-radius: 4px; }
    .draggable-label:hover, button:hover {
          background: #3498db; 
      }
    select, input[type="color"] { 
      background: #2c3e50; 
      color: #ecf0f1; 
    }
    .style-controls {
       margin: 12px 0;
       }
    .style-controls button { 
      width: 32%;
       display: inline-block;
        margin-right: 2%;
       }
    #canvasContainer { 
      flex: 1;
       overflow: auto;
        background: #e4e4e2;
         position: relative;
       }
#letterheadBackground {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  opacity: 0.5;
  pointer-events: none;
  z-index: 0;
  transition: background-image 0.3s ease;
}

/* Update canvas styles to ensure proper layering */
#canvas {
  position: relative;
  background: white; /* Changed from #f9f9f9 to transparent */
  margin: 100px;
  border: 1px solid #000;
}

.label-box {
  position: absolute;
  font-size: 14px;
  cursor: move;
  user-select: none;
  padding: 2px;
  background: rgba(255, 255, 255, 0.7); /* Semi-transparent white background */
  border: none;
  outline: none;
  min-width: 40px;
  z-index: 1; /* Ensure labels appear above the background */
}

/* Toggle Switch Styles */
.toggle-switch {
  display: flex;
  align-items: center;
  margin: 10px 0;
}

.toggle-switch input[type="checkbox"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 50px;
  height: 24px;
  background: #2c3e50;
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  outline: none;
  transition: background 0.3s;
  margin-right: 10px;
}

.toggle-switch input[type="checkbox"]:checked {
  background: #2980b9;
}

.toggle-switch input[type="checkbox"]::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #ecf0f1;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}

.toggle-switch input[type="checkbox"]:checked::before {
  transform: translateX(26px);
}

.toggle-switch label {
  color: white;
  cursor: pointer;
  user-select: none;
}
    
    .label-box.selected { background-color: rgba(76, 48, 186, 0.2); }
    .resizer { width: 8px; height: 8px; background: #2980b9; position: absolute; right: -4px; bottom: -4px; cursor: se-resize; border-radius: 2px; display: none; }
    #xGuide, #yGuide { position: absolute; background: rgba(231,76,60,0.6); z-index: 999; display: none; }
    #xGuide { height: 1px; width: 100%; }
    #yGuide { width: 1px; height: 100%; }

    /* ← PAGE IMAGE MODAL STYLES ← */
   #paperSelectModal {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.7);
  z-index:10000;
  font-family: 'Segoe UI', sans-serif;
}

.modal-content {
  display: flex;
  gap: 30px;
  margin: 20px 0;
}

.selection-section {
  flex: 1;
  text-align: center;
}

.selection-section h4 {
  margin: 0 0 15px 0;
  font-size: 18px;
  color: #000000;
  font-weight: 600;
}

.show-more-btn {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  border: none;
  background: #3498db;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  text-align: center;
}

.show-more-btn:hover {
  background: #2980b9;
}

.options-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.option {
   display: flex;
  flex-direction: column;
  align-items: center; /* This centers everything horizontally */
  text-align: center; /* This centers the text */
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 8px;
  padding: 10px;
}

.option:hover {
  background: rgba(52, 152, 219, 0.1);
  transform: translateY(-2px);
}

.option.selected {
  background: rgba(52, 152, 219, 0.1);
  box-shadow: 0 0 0 2px #3498db;
}

.option img {
  width: 100%;
  height: 120px;
  object-fit: contain;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-bottom: 8px;
}

.option .preview {
  width: 100%;
  height: 120px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-bottom: 8px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}


.custom-bg {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #7f8c8d;
  background-color: #f5f5f5;
}

.option label {
  display: block;
  font-size: 14px;
  color: #34495e;
  margin-top: 5px;
}

.modal-footer {
  margin-top: 20px;
}

.modal-footer button {
  padding: 12px 24px;
  font-size: 16px;
  background: #2980b9;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

.modal-footer button:hover {
  background: #3498db;
}

#paperSelectModal .modal {
  background: #ffffff;
  padding: 30px;
  border-radius: 12px;
  width: 800px; /* Increased width */
  max-width: 90vw;
  text-align: center;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  animation: fadeInUp 0.4s ease-out;
}

#paperSelectModal h3 {
  margin-top:0;
  font-size: 22px;
  color: #5391cf;
  margin-bottom: 20px;
}

.page-option {
  display: inline-block;
  margin: 20px 10px;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-radius: 8px;
  padding: 6px;
  position: relative;
}

.page-option:hover {
  background: rgba(52, 152, 219, 0.1);
  box-shadow: 0 0 12px rgba(52, 152, 219, 0.5);
  transform: scale(1.05);
}

.page-option img {
  width: 100px;
  height: auto;
  border: 2px solid #34495e;
  border-radius: 4px;
  transition: border-color 0.3s ease;
}

.page-option.selected {
  animation: pop 0.4s ease;
  box-shadow: 0 0 20px rgba(52, 152, 219, 0.7);
  background: rgba(52, 152, 219, 0.1);
  border-radius: 8px;
  transform: scale(1.05);
}

.page-option.selected img {
  border: 3px solid #2980b9;
  box-shadow: 0 4px 10px rgba(41, 128, 185, 0.6);
}

.page-option label {
  display: block;
  margin-top: 5px;
  font-size: 14px;
  color: #34495e;
}

#xDistanceGuide, #yDistanceGuide { 
  position: absolute; 
  background: rgba(46, 204, 113, 0.6); /* Green color for distance guides */
  z-index: 999; 
  display: none; 
}
#xDistanceGuide { height: 1px; width: 100%; }
#yDistanceGuide { width: 1px; height: 100%; }

.distance-tooltip {
  position: absolute;
  background: #2c3e50;
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  z-index: 1000;
  display: none;
  pointer-events: none;
}

/* Add to your existing styles */
.selection-options {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.page-options, .background-options {
  flex: 1;
}

.background-options h4, .page-options h4 {
  color: #34495e;
  margin-bottom: 10px;
  font-size: 16px;
}

.background-option {
  display: inline-block;
  margin: 10px;
  cursor: pointer;
  text-align: center;
}

.bg-preview {
  width: 100px;
  height: 140px;
  border: 2px solid #34495e;
  border-radius: 4px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 5px;
  transition: all 0.3s ease;
}

.no-bg {
  background: linear-gradient(45deg, #eee 25%, #fff 25%, #fff 50%, #eee 50%, #eee 75%, #fff 75%);
  background-size: 20px 20px;
}


.background-option.selected .bg-preview {
  border: 3px solid #2980b9;
  box-shadow: 0 4px 10px rgba(41, 128, 185, 0.6);
}

.background-option label {
  display: block;
  font-size: 14px;
  color: #34495e;
}

input[type="range"] {
  width: 100%;
  margin: 8px 0;
}

/* Animations */
@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}



@keyframes fadeInUp {
  from {
    transform: translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Add to your existing CSS */
.label-box[data-placeholder]:empty:before {
  content: attr(data-placeholder);
  color: #999;
  font-style: italic;
}

.labels-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 15px 0 8px 0;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
}

.labels-header:hover {
  border-bottom-color: rgba(255,255,255,0.4);
}

.toggle-labels {
  background: none;
  border: none;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  cursor: pointer;
  padding: 0;
  color: white;
  transition: all 0.3s ease;
}

.toggle-labels:hover {
  background: rgba(255,255,255,0.1);
}

.toggle-labels svg {
  transition: transform 0.3s ease;
}

.labels-container {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, opacity 0.2s ease;
  opacity: 0;
}

.values-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 15px 0 8px 0;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
}

.values-header:hover {
  border-bottom-color: rgba(255,255,255,0.4);
}

.toggle-values {
  background: none;
  border: none;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  cursor: pointer;
  padding: 0;
  color: white;
  transition: all 0.3s ease;
}

.toggle-values:hover {
  background: rgba(255,255,255,0.1);
}

.values-container {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, opacity 0.2s ease;
  opacity: 0;
}

.values-container.expanded {
  max-height: 500px;
  opacity: 1;
  transition: max-height 0.3s ease-in, opacity 0.3s ease 0.1s;
}

.labels-container.expanded {
  max-height: 500px; /* Adjust based on your content */
  opacity: 1;
  transition: max-height 0.3s ease-in, opacity 0.3s ease 0.1s;
}

/* Icons Animation */
.labels-container.expanded ~ .labels-header .plus-icon {
  transform: rotate(90deg);
}

.labels-container.expanded ~ .labels-header .minus-icon {
  display: block;
}

.labels-container.expanded ~ .labels-header .plus-icon {
  display: none;
}

/* Styles for all collapsible sections */
.styles-header,
.background-header,
.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 15px 0 8px 0;
  padding-bottom: 5px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
}

.styles-header:hover,
.background-header:hover,
.controls-header:hover {
  border-bottom-color: rgba(255,255,255,0.4);
}

.toggle-styles,
.toggle-background,
.toggle-controls {
  background: none;
  border: none;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  cursor: pointer;
  padding: 0;
  color: white;
  transition: all 0.3s ease;
}

.toggle-styles:hover,
.toggle-background:hover,
.toggle-controls:hover {
  background: rgba(255,255,255,0.1);
}

.styles-container,
.background-container,
.controls-container {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out, opacity 0.2s ease;
  opacity: 0;
}

.styles-container.expanded,
.background-container.expanded,
.controls-container.expanded {
  max-height: 1000px; /* Adjust based on content */
  opacity: 1;
  transition: max-height 0.3s ease-in, opacity 0.3s ease 0.1s;
}

/* Specific adjustments for controls section */
.controls-container h4 {
  margin: 15px 0 8px 0;
  color: white;
  font-weight: normal;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  padding-bottom: 5px;
}


  </style>
</head>
<body>

  <!-- 📐 PAPER SIZE SELECTION MODAL -->
 <div id="paperSelectModal">
  <div class="modal">
    <h3>Report Layout Setup</h3>
    
    <div class="modal-content">
      <!-- Paper Size Selection -->
      <div class="selection-section">
        <h4>Select Paper Size</h4>
        <div class="options-grid">
          <div class="option" data-size="A4" onclick="selectPage('A4')">
            <img src="./images/A4.png" alt="A4 Page">
            <label>A4</label>
          </div>
          <div class="option" data-size="A5" onclick="selectPage('A5')">
            <img src="./images/A5.png" alt="A5 Page">
            <label>A5</label>
          </div>
          <div class="option" data-size="B4" onclick="selectPage('B4')">
            <img src="./images/B4.png" alt="B4 Page">
            <label>B4</label>
          </div>
          <div class="option" data-size="Letter" onclick="selectPage('Letter')">
            <img src="./images/Letter.png" alt="Letter Page">
            <label>Letter</label>
          </div>
        </div>
      </div>
      
      <!-- Background Selection -->
      <div class="selection-section">
        <h4>Select Background</h4>
        <div class="options-grid">
          <div class="option" onclick="selectBackground('none')">
            <div class="preview no-bg"></div>
            <label>No Background</label>
          </div>
          <div class="option" onclick="selectBackground('letterhead')">
            <div class="preview" style="background-image: url('./images/letterhead.png')"></div>
            <label>Sivasakthi Letterhead</label>
          </div>
          <div class="option" onclick="selectBackground('grid')">
            <div class="preview" style="background-image: url('./images/MDC.png')"></div>
            <label>MDC Letterhead</label>
          </div>
          <div class="option" onclick="selectBackground('custom')">
            <div class="preview custom-bg">+</div>
            <label>Custom Image</label>
            <input type="file" id="customBgUpload" accept="image/*" style="display: none;">
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button onclick="startDesigning()">Start Designing</button>
    </div>
  </div>
</div>

  <!-- 🧰 SIDEBAR -->
  <div id="sidebar">
<!-- Replace the entire labels and values sections in the sidebar with this: -->
<h3 class="labels-header">
  <span>LABELS</span>
  <button class="toggle-labels">
    <svg class="plus-icon" width="16" height="16" viewBox="0 0 16 16">
      <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg class="minus-icon" width="16" height="16" viewBox="0 0 16 16" style="display: none;">
      <path d="M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</h3>
<div class="labels-container">
  <div class="draggable-label" draggable="true" data-label="Blank Label">Blank Label</div>
  <!-- Labels will be generated dynamically here -->
  <div id="dynamic-labels"></div>
 <button id="prevLabels" class="show-more-btn" style="display: none;">Previous</button>
<button id="nextLabels" class="show-more-btn">Next</button>
</div>

<h3 class="values-header">
  <span>VALUES</span>
  <button class="toggle-values">
    <svg class="plus-icon" width="16" height="16" viewBox="0 0 16 16">
      <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg class="minus-icon" width="16" height="16" viewBox="0 0 16 16" style="display: none;">
      <path d="M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</h3>
<div class="values-container">
  <!-- Values will be generated dynamically here -->
  <div id="dynamic-values"></div>
<button id="prevValues" class="show-more-btn" style="display: none;">Previous</button>
<button id="nextValues" class="show-more-btn">Next</button>
</div>


<!-- Styles Section -->
<h3 class="styles-header">
  <span>STYLES</span>
  <button class="toggle-styles">
    <svg class="plus-icon" width="16" height="16" viewBox="0 0 16 16">
      <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg class="minus-icon" width="16" height="16" viewBox="0 0 16 16" style="display: none;">
      <path d="M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</h3>
<div class="styles-container">
  <label>Font Size</label>
  <select id="fontSize">
    <option value="11px">11</option>
    <option value="12px" selected>12</option>
    <option value="14px">14</option>
    <option value="18px">18</option>
    <option value="24px">24</option>
    <option value="30px">30</option>
  </select>
  <label>Font Family</label>
  <select id="fontFamily">
    <option value="Arial">Arial</option>
    <option value="Georgia">Georgia</option>
    <option value="Courier New">Courier New</option>
    <option value="Times New Roman">Times New Roman</option>
  </select>
  <label>Font Color</label>
  <input type="color" id="fontColor" value="#000000">

  <div class="style-controls">
    <button id="btnBold"><strong>B</strong></button>
    <button id="btnItalic"><em>I</em></button>
    <button id="btnUnderline"><u>U</u></button>
  </div>
  <div class="style-controls">
    <button id="alignLeft">Left</button>
    <button id="alignCenter">Center</button>
    <button id="alignRight">Right</button>
  </div>
</div>

<!-- Background Section -->
<h3 class="background-header">
  <span>BACKGROUND</span>
  <button class="toggle-background">
    <svg class="plus-icon" width="16" height="16" viewBox="0 0 16 16">
      <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg class="minus-icon" width="16" height="16" viewBox="0 0 16 16" style="display: none;">
      <path d="M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</h3>
<div class="background-container">
  <label>Opacity</label>
  <input type="range" id="bgOpacity" min="10" max="100" value="50">
  <button id="toggleBackground">Toggle Background</button>
</div>

<!-- Controls Section -->
<h3 class="controls-header">
  <span>CONTROLS</span>
  <button class="toggle-controls">
    <svg class="plus-icon" width="16" height="16" viewBox="0 0 16 16">
      <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg class="minus-icon" width="16" height="16" viewBox="0 0 16 16" style="display: none;">
      <path d="M1 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</h3>
<div class="controls-container">
  <!-- Zoom Controls -->
  <button onclick="zoomIn()">Zoom In</button>
  <button onclick="zoomOut()">Zoom Out</button>
  <button onclick="resetZoom()">Reset Zoom</button>

  <!-- Action Controls -->
  <button id="clearAllLabels">Clear All Labels</button>
  <button id="deleteSelected">Delete Selected</button>

  <!-- Guide Settings -->
  <h4>GUIDE SETTINGS</h4>
  <label>Guide Color</label>
  <input type="color" id="guideColor" value="#e74c3c">
  <label>Distance Guide Color</label>
  <input type="color" id="distanceGuideColor" value="#2ecc71">
  <!-- <label>Minimum Spacing</label>
  <input type="range" id="minSpacing" min="10" max="100" value="20">
  <span id="minSpacingValue">20px</span> -->

  <div class="toggle-switch">
    <label for="toggleGuides">Show Guides</label>
    <input type="checkbox" id="toggleGuides" checked>
  </div>
  <div class="toggle-switch">
    <label for="toggleDistanceGuides">Show Distance </label>
    <input type="checkbox" id="toggleDistanceGuides" checked>
  </div>

  <!-- Export Controls -->
  <button id="exportJSON">Export JSON</button>
  <button id="exportPNG">Export as PNG</button>
</div>
</div>


  <!-- 🖼 Scrollable Canvas Wrapper -->
  <div id="canvasContainer">
    <div id="canvas">
      <div id="letterheadBackground"></div>
      <div id="xDistanceGuide"></div>
      <div id="yDistanceGuide"></div>
      <div id="distanceValue" class="distance-tooltip"></div>
      <div id="xGuide"></div>
      <div id="yGuide"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>

    // Sample data (this would come from API in real implementation)
const reportData = {
  age: "age",
  barcode: "barcode",
  Patient_id: "client_id",
  collected_date:"collected_date",
  collected_on: "collected_on",
  collection: "collection",
  created_at: "created_at",
  culture_id: "collection",
  date: "date",
  delete_status: "delete_status",
  discount: "discount",
  doctor_email: "doctor_email",
  doctor_id: "doctor_id",
  referred_by : "doctor_name",
  doctor_phone: "doctor_phone",
  due_amount: "due_amount",
  group_id: "group_id",
  hospital_name: "hospital_name",
  id_no: "id_no",
  loggedinid: "loggedinid",
  multisign: "multisign",
  order_date: "order_date",
  order_id: "order_id",
  orderedtestgroup: "orderedtestgroup",
  paid_amount: "paid_amount",
  patient_address: "patient_address",
  patient_code: "patient_code",
  patient_dob: "patient_dob",
  patient_email: "patient_email",
  patient_gender: "patient_gender",
  patient_name: "patient_name",
  patient_phone: "patient_phone",
  prescription: "prescription",
  recievedsample: "recievedsample",
  report_date: "report_date",
  report_id: "report_id",
  report_status: "report_status",
  reported_on: "reported_on",
  sample_id: "sample_id",
  signature_id: "signature_id",
  signatures: "signatures",
  status: "status",
  subtotal: "subtotal",
  ta_time: "ta_time",
  test_id: "test_id",
  testorder: "testorder",
  workorder_id: "workorder_id",
  workorder_status: "workorder_status"
};

// Variables for pagination
let currentLabelPage = 1;
let currentValuePage = 1;
const itemsPerPage = 6;

// Function to generate label elements
function generateLabels(page = 1) {
  const labelsContainer = document.getElementById('dynamic-labels');
  labelsContainer.innerHTML = '';
  
  const keys = Object.keys(reportData);
  const startIdx = (page - 1) * itemsPerPage;
  const endIdx = startIdx + itemsPerPage;
  
  keys.slice(startIdx, endIdx).forEach(key => {
    if (reportData[key] !== null && reportData[key] !== "") {
      const labelDiv = document.createElement('div');
      labelDiv.className = 'draggable-label';
      labelDiv.draggable = true;
      labelDiv.setAttribute('data-label', key);
      labelDiv.textContent = formatLabelText(key);
      labelsContainer.appendChild(labelDiv);
    }
  });
  
  // Show/hide navigation buttons
  const prevLabelsBtn = document.getElementById('prevLabels');
  const nextLabelsBtn = document.getElementById('nextLabels');
  
  prevLabelsBtn.style.display = page > 1 ? 'block' : 'none';
  nextLabelsBtn.style.display = endIdx < keys.length ? 'block' : 'none';
}

// Function to generate value elements
// Function to generate value elements (updated version without colons)
function generateValues(page = 1) {
  const valuesContainer = document.getElementById('dynamic-values');
  valuesContainer.innerHTML = '';
  
  const keys = Object.keys(reportData);
  const startIdx = (page - 1) * itemsPerPage;
  const endIdx = startIdx + itemsPerPage;
  
  keys.slice(startIdx, endIdx).forEach(key => {
    if (reportData[key] !== null && reportData[key] !== "") {
      const valueDiv = document.createElement('div');
      valueDiv.className = 'draggable-label';
      valueDiv.draggable = true;
      valueDiv.setAttribute('data-label', reportData[key]);
      valueDiv.textContent = formatValueText(reportData[key]);
      valuesContainer.appendChild(valueDiv);
    }
  });
  
  // Show/hide navigation buttons
  const prevValuesBtn = document.getElementById('prevValues');
  const nextValuesBtn = document.getElementById('nextValues');
  
  prevValuesBtn.style.display = page > 1 ? 'block' : 'none';
  nextValuesBtn.style.display = endIdx < keys.length ? 'block' : 'none';
}



// Helper function to format label text (capitalize and add spaces)
function formatLabelText(key) {
  return key.replace(/_/g, ' ')
            .replace(/([A-Z])/g, ' $1')
            .replace(/^./, str => str.toUpperCase());
}

// Helper function to format value text
function formatValueText(value) {
  if (value === null || value === undefined) return '';
  return value.toString();
}

// Event listeners for show more buttons
document.getElementById('nextLabels').addEventListener('click', () => {
  currentLabelPage++;
  generateLabels(currentLabelPage);
});

document.getElementById('prevLabels').addEventListener('click', () => {
  currentLabelPage--;
  generateLabels(currentLabelPage);
});

document.getElementById('nextValues').addEventListener('click', () => {
  currentValuePage++;
  generateValues(currentValuePage);
});

document.getElementById('prevValues').addEventListener('click', () => {
  currentValuePage--;
  generateValues(currentValuePage);
});


// Initialize the labels and values when the page loads
document.addEventListener('DOMContentLoaded', () => {
  generateLabels();
  generateValues();
  
  // Make sure the draggable functionality works for dynamically generated elements
  document.addEventListener('mouseover', () => {
    document.querySelectorAll('.draggable-label').forEach(lbl => {
      lbl.ondragstart = e => e.dataTransfer.setData('text/plain', lbl.dataset.label);
    });
  });
});

let selectedBackground = 'none';
let customBackgroundImage = null;

function selectBackground(bgType) {
  selectedBackground = bgType;
  
  // Remove selection from all background options
  document.querySelectorAll('.selection-section:nth-child(2) .option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // Add selection to clicked option
  const selectedOption = document.querySelector(`.option[onclick="selectBackground('${bgType}')"]`);
  if (selectedOption) {
    selectedOption.classList.add('selected');
  }
  
  // Handle custom image upload
  if (bgType === 'custom') {
    document.getElementById('customBgUpload').click();
  }
}
// Handle custom background upload
document.getElementById('customBgUpload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      customBackgroundImage = event.target.result;
      // Update the preview
      const customPreview = document.querySelector('.background-option[onclick="selectBackground(\'custom\')"] .bg-preview');
      customPreview.style.backgroundImage = `url(${customBackgroundImage})`;
      customPreview.textContent = '';
    };
    reader.readAsDataURL(file);
  }
});

let guideSettings = {
  enabled: true,
  distanceEnabled: true,
  guideColor: '#e74c3c',
  distanceColor: '#2ecc71',
  minSpacing: 20
};

    const paperSizes = {
      A4: { w: 210, h: 297 },
      A5: { w: 148, h: 210 },
      B4: { w: 250, h: 353 },
      Letter: { w: 216, h: 279 }
    };
    const PPM = 3.78;
    let zoomLevel = 1, editMode = true, selectedElement = null;


    
    const canvas = document.getElementById('canvas'),
     xGuide = document.getElementById('xGuide'), yGuide = document.getElementById('yGuide');

   function selectPage(page) {
  document.querySelectorAll('.option[data-size]').forEach(option => {
    option.classList.remove('selected');
  });
  const selectedOption = document.querySelector(`.option[data-size="${page}"]`);
  selectedOption.classList.add('selected');
  selectedPage = page;
}

function startDesigning() {
  if (!selectedPage) {
    alert('Please select a page size!');
    return;
  }
  
  const { w, h } = paperSizes[selectedPage];
  const pw = w * PPM, ph = h * PPM;
  canvas.style.width = `${pw}px`;
  canvas.style.height = `${ph}px`;
  
  // Set letterhead background
  const letterheadBg = document.getElementById('letterheadBackground');
  letterheadBg.style.width = `${pw}px`;
  letterheadBg.style.height = `${ph}px`;
  
  // Apply selected background
  switch(selectedBackground) {
    case 'none':
      letterheadBg.style.backgroundImage = 'none';
      letterheadBg.style.display = 'none';
      break;
    case 'letterhead':
      letterheadBg.style.backgroundImage = 'url("./images/letterhead.png")';
      letterheadBg.style.display = 'block';
      break;
    case 'grid':
      letterheadBg.style.backgroundImage = 'url("./images/MDC.png")';
      letterheadBg.style.display = 'block';
      break;
    case 'custom':
      if (customBackgroundImage) {
        letterheadBg.style.backgroundImage = `url(${customBackgroundImage})`;
        letterheadBg.style.display = 'block';
      } else {
        letterheadBg.style.backgroundImage = 'none';
        letterheadBg.style.display = 'none';
      }
      break;
  }
  
  document.getElementById('paperSelectModal').style.display = 'none';
  enableInteractions();
}


    function setPaperSize(){
      const sel = document.getElementById('paperSize').value;
      const {w,h} = paperSizes[sel];
      const pw = w*PPM, ph = h*PPM;
      canvas.style.width = `${pw}px`;
      canvas.style.height = `${ph}px`;
      document.getElementById('paperSelectModal').style.display = 'none';
      enableInteractions();
    }

    function enableInteractions(){
      document.querySelectorAll('.draggable-label').forEach(lbl=>{
        lbl.ondragstart=e=>e.dataTransfer.setData('text/plain', lbl.dataset.label);
      });
      canvas.ondragover=e=>e.preventDefault();
      canvas.ondrop=e=>{
        e.preventDefault();
        const t=e.dataTransfer.getData('text/plain');
        const rect=canvas.getBoundingClientRect();
        createLabel(t, e.clientX-rect.left, e.clientY-rect.top);
      };

    
      document.getElementById('deleteSelected').onclick=()=>{if(selectedElement){selectedElement.remove(); saveLayout(); selectedElement=null;}};
      document.addEventListener('keydown', e=>{ if(e.key==='Delete'&&selectedElement){selectedElement.remove(); saveLayout(); selectedElement=null;} });

      document.getElementById('fontSize').onchange=e=>{if(selectedElement){selectedElement.style.fontSize=e.target.value; saveLayout();}};
      document.getElementById('fontColor').onchange=e=>{if(selectedElement){selectedElement.style.color=e.target.value; saveLayout();}};
      document.getElementById('fontFamily').onchange=e=>{if(selectedElement){selectedElement.style.fontFamily=e.target.value; saveLayout();}};
      ['btnBold','btnItalic','btnUnderline','alignLeft','alignCenter','alignRight']
        .forEach(id=>document.getElementById(id).onclick=()=>{
          if(!selectedElement) return;
          const s = selectedElement.style;
          if(id==='btnBold') s.fontWeight = s.fontWeight==='bold'?'normal':'bold';
          if(id==='btnItalic') s.fontStyle = s.fontStyle==='italic'?'normal':'italic';
          if(id==='btnUnderline') s.textDecoration = s.textDecoration==='underline'?'none':'underline';
          if(id==='alignLeft') s.textAlign='left';
          if(id==='alignCenter') s.textAlign='center';
          if(id==='alignRight') s.textAlign='right';
          saveLayout();
        });

      document.getElementById('exportJSON').onclick=()=>{
        localStorage.setItem('builderLayout', JSON.stringify(getLayoutData()));
        alert('Saved JSON');
      };
      document.getElementById('exportPNG').onclick=()=>{
        html2canvas(canvas).then(c=>{ const a=document.createElement('a'); a.download='layout.png'; a.href=c.toDataURL(); a.click(); });
      };

      document.getElementById('clearAllLabels').onclick = () => {
  if (confirm('Are you sure you want to remove all labels from the report?')) {
    document.querySelectorAll('.label-box').forEach(label => label.remove());
    saveLayout();
    selectedElement = null;
  }
};


// Guide controls
document.getElementById('guideColor').onchange = e => {
  guideSettings.guideColor = e.target.value;
  xGuide.style.background = yGuide.style.background = guideSettings.guideColor;
};
document.getElementById('distanceGuideColor').onchange = e => {
  guideSettings.distanceColor = e.target.value;
  xDistanceGuide.style.background = yDistanceGuide.style.background = guideSettings.distanceColor;
};
// document.getElementById('minSpacing').oninput = e => {
//   guideSettings.minSpacing = parseInt(e.target.value);
//   document.getElementById('minSpacingValue').textContent = `${guideSettings.minSpacing}px`;
// };
document.getElementById('toggleGuides').addEventListener('change', (e) => {
  guideSettings.enabled = e.target.checked;
  if (!guideSettings.enabled) clearSnap();
});
document.getElementById('toggleDistanceGuides').addEventListener('change', (e) => {
  guideSettings.distanceEnabled = e.target.checked;
  if (!guideSettings.distanceEnabled) {
    xDistanceGuide.style.display = yDistanceGuide.style.display = 'none';
    document.getElementById('distanceValue').style.display = 'none';
  }
});

// Add to enableInteractions() function
document.getElementById('bgOpacity').oninput = e => {
  document.getElementById('letterheadBackground').style.opacity = e.target.value / 100;
};
document.getElementById('toggleBackground').onclick = () => {
  const bg = document.getElementById('letterheadBackground');
  bg.style.display = bg.style.display === 'none' ? 'block' : 'none';
};

document.querySelector('.labels-header').addEventListener('click', function() {
  const container = document.querySelector('.labels-container');
  container.classList.toggle('expanded');
  
  // Update ARIA attributes for accessibility
  const isExpanded = container.classList.contains('expanded');
  this.setAttribute('aria-expanded', isExpanded);
  container.setAttribute('aria-hidden', !isExpanded);
});

document.querySelector('.values-header').addEventListener('click', function() {
  const container = document.querySelector('.values-container');
  container.classList.toggle('expanded');
  
  // Update ARIA attributes for accessibility
  const isExpanded = container.classList.contains('expanded');
  this.setAttribute('aria-expanded', isExpanded);
  container.setAttribute('aria-hidden', !isExpanded);
});

// Toggle Styles section
document.querySelector('.styles-header').addEventListener('click', function() {
  const container = document.querySelector('.styles-container');
  container.classList.toggle('expanded');
  this.setAttribute('aria-expanded', container.classList.contains('expanded'));
  container.setAttribute('aria-hidden', !container.classList.contains('expanded'));
});

// Toggle Background section
document.querySelector('.background-header').addEventListener('click', function() {
  const container = document.querySelector('.background-container');
  container.classList.toggle('expanded');
  this.setAttribute('aria-expanded', container.classList.contains('expanded'));
  container.setAttribute('aria-hidden', !container.classList.contains('expanded'));
});

// Toggle Controls section
document.querySelector('.controls-header').addEventListener('click', function() {
  const container = document.querySelector('.controls-container');
  container.classList.toggle('expanded');
  this.setAttribute('aria-expanded', container.classList.contains('expanded'));
  container.setAttribute('aria-hidden', !container.classList.contains('expanded'));
});


      loadLayout();
    }

// Modify the createLabel function
function createLabel(text, x, y) {
  // Get canvas dimensions
  const canvasRect = canvas.getBoundingClientRect();
  const canvasWidth = parseInt(canvas.style.width);
  const canvasHeight = parseInt(canvas.style.height);
  
  // Constrain position to be within canvas
  x = Math.max(0, Math.min(x, canvasWidth - 40)); // Minimum width of 40px
  y = Math.max(0, Math.min(y, canvasHeight - 20)); // Minimum height of 20px
  
  const div = document.createElement('div');
  div.className = 'label-box'; 
  
  // Handle blank label differently
  if (text === "Blank Label") {
    div.setAttribute('data-placeholder', 'Enter your text here...');
    div.contentEditable = true;
  } else {
    div.textContent = text;
    div.contentEditable = true;
  }
  
  div.style.left = `${x}px`; 
  div.style.top = `${y}px`; 
  div.style.fontSize = '14px';
  
  const r = document.createElement('div'); 
  r.className = 'resizer'; 
  div.appendChild(r);
  
  makeDraggable(div); 
  makeResizable(div, r); 
  canvas.appendChild(div); 
  saveLayout();
  
  // Focus the blank label when created
  if (text === "Blank Label") {
    div.focus();
  }
}

    function makeDraggable(el){
      el.onmousedown=e=>{
        if(!editMode||e.target.classList.contains('resizer')) return;
        document.querySelectorAll('.label-box').forEach(b=>{b.classList.remove('selected'); b.querySelector('.resizer').style.display='none';});
        el.classList.add('selected'); selectedElement=el;
        el.querySelector('.resizer').style.display='block';
        startDrag(e,(dx,dy)=>{el.style.left=dx; el.style.top=dy; drawSnap(el);}, ()=>{
          clearSnap(); saveLayout();
        });
      };
      el.oninput = ()=>saveLayout();
    }
 
function startDrag(e, moveFn, endFn) {
  const rect = canvas.getBoundingClientRect();
  const canvasWidth = parseInt(canvas.style.width);
  const canvasHeight = parseInt(canvas.style.height);
  
  const sx = e.clientX - rect.left - parseInt(e.target.style.left);
  const sy = e.clientY - rect.top - parseInt(e.target.style.top);
  
  function onMove(ev) {
    let x = (ev.clientX - rect.left - sx);
    let y = (ev.clientY - rect.top - sy);
    
    // Constrain to canvas boundaries
    const elWidth = e.target.offsetWidth;
    const elHeight = e.target.offsetHeight;
    
    x = Math.max(0, Math.min(x, canvasWidth - elWidth));
    y = Math.max(0, Math.min(y, canvasHeight - elHeight));
    
    moveFn(`${x}px`, `${y}px`);
  }
  
  function onUp() { 
    document.removeEventListener('mousemove', onMove); 
    document.removeEventListener('mouseup', onUp); 
    endFn(); 
  }
  
  document.addEventListener('mousemove', onMove); 
  document.addEventListener('mouseup', onUp);
}

  function makeResizable(box, handle) {
  handle.onmousedown = e => {
    e.stopPropagation();
    const canvasWidth = parseInt(canvas.style.width);
    const canvasHeight = parseInt(canvas.style.height);
    
    const maxWidth = canvasWidth - box.offsetLeft;
    const maxHeight = canvasHeight - box.offsetTop;
    
    const sw = box.offsetWidth, sh = box.offsetHeight, sx = e.clientX, sy = e.clientY;
    
    function onMove(ev) {
      const newWidth = Math.min(maxWidth, sw + (ev.clientX - sx));
      const newHeight = Math.min(maxHeight, sh + (ev.clientY - sy));
      
      // Minimum size constraints
      if (newWidth >= 40 && newHeight >= 20) {
        box.style.width = `${newWidth}px`;
        box.style.height = `${newHeight}px`;
      }
    }
    
    function onUp() { 
      document.removeEventListener('mousemove', onMove); 
      document.removeEventListener('mouseup', onUp); 
      saveLayout(); 
    }
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  };
}

    function zoomIn(){ zoomLevel+=0.1; applyZoom(); }
    function zoomOut(){ zoomLevel=Math.max(0.2,zoomLevel-0.1); applyZoom(); }
    function resetZoom(){ zoomLevel=1; applyZoom(); }
    function applyZoom(){ canvas.style.transform=`scale(${zoomLevel})`; }

 function drawSnap(el) {
  if (!guideSettings.enabled) return;
  
  clearSnap();
  const others = [...document.querySelectorAll('.label-box')].filter(b => b !== el);
  const r1 = el.getBoundingClientRect();
  const cr = canvas.getBoundingClientRect();
  const distanceValue = document.getElementById('distanceValue');
  
  // Standard alignment guides (existing functionality)
  others.forEach(o => {
    const r2 = o.getBoundingClientRect();
    if(Math.abs(r1.left - r2.left) < 8) { 
      yGuide.style.left = `${r2.left - cr.left}px`; 
      yGuide.style.top = '0'; 
      yGuide.style.display = 'block'; 
    }
    if(Math.abs(r1.top - r2.top) < 8) { 
      xGuide.style.top = `${r2.top - cr.top}px`; 
      xGuide.style.left = '0'; 
      xGuide.style.display = 'block'; 
    }
  });

  // New improved distance guides
  if (guideSettings.distanceEnabled && others.length >= 2) {
    // Get all element positions
    const positions = others.map(o => {
      const r = o.getBoundingClientRect();
      return { left: r.left, top: r.top, right: r.right, bottom: r.bottom };
    });

    // Check horizontal spacing patterns
    const sortedX = [...positions].sort((a, b) => a.left - b.left);
    const xSpacings = [];
    
    // Calculate all horizontal spacings between elements
    for (let i = 1; i < sortedX.length; i++) {
      const spacing = sortedX[i].left - sortedX[i-1].left;
      if (spacing >= guideSettings.minSpacing) {
        xSpacings.push(spacing);
      }
    }

    // Check if current element matches any existing horizontal spacing
    xSpacings.forEach(spacing => {
      // Check left side
      positions.forEach(pos => {
        const targetLeft = pos.left - spacing;
        if (Math.abs(r1.left - targetLeft) < 8) {
          yDistanceGuide.style.left = `${targetLeft - cr.left}px`;
          yDistanceGuide.style.display = 'block';
          showDistanceValue(spacing, targetLeft - cr.left, r1.top - cr.top);
        }
      });

      // Check right side
      positions.forEach(pos => {
        const targetLeft = pos.left + spacing;
        if (Math.abs(r1.left - targetLeft) < 8) {
          yDistanceGuide.style.left = `${targetLeft - cr.left}px`;
          yDistanceGuide.style.display = 'block';
          showDistanceValue(spacing, targetLeft - cr.left, r1.top - cr.top);
        }
      });
    });

    // Check vertical spacing patterns
    const sortedY = [...positions].sort((a, b) => a.top - b.top);
    const ySpacings = [];
    
    // Calculate all vertical spacings between elements
    for (let i = 1; i < sortedY.length; i++) {
      const spacing = sortedY[i].top - sortedY[i-1].top;
      if (spacing >= guideSettings.minSpacing) {
        ySpacings.push(spacing);
      }
    }

    // Check if current element matches any existing vertical spacing
    ySpacings.forEach(spacing => {
      // Check top side
      positions.forEach(pos => {
        const targetTop = pos.top - spacing;
        if (Math.abs(r1.top - targetTop) < 8) {
          xDistanceGuide.style.top = `${targetTop - cr.top}px`;
          xDistanceGuide.style.display = 'block';
          showDistanceValue(spacing, r1.left - cr.left, targetTop - cr.top);
        }
      });

      // Check bottom side
      positions.forEach(pos => {
        const targetTop = pos.top + spacing;
        if (Math.abs(r1.top - targetTop) < 8) {
          xDistanceGuide.style.top = `${targetTop - cr.top}px`;
          xDistanceGuide.style.display = 'block';
          showDistanceValue(spacing, r1.left - cr.left, targetTop - cr.top);
        }
      });
    });
  }
}

function showDistanceValue(distance, x, y) {
  const distanceValue = document.getElementById('distanceValue');
  distanceValue.textContent = `${Math.round(distance)}px`;
  distanceValue.style.left = `${x + 10}px`;
  distanceValue.style.top = `${y + 10}px`;
  distanceValue.style.display = 'block';
}

function clearSnap() {
  xGuide.style.display = yGuide.style.display = 'none';
  xDistanceGuide.style.display = yDistanceGuide.style.display = 'none';
  document.getElementById('distanceValue').style.display = 'none';
}


    

    function saveLayout(){
      localStorage.setItem('builderLayout', JSON.stringify(getLayoutData()));
    }
    function getLayoutData(){
      return [...document.querySelectorAll('.label-box')].map(b=>({
        text:b.innerText,
        x:parseInt(b.style.left),
        y:parseInt(b.style.top),
        fontSize:b.style.fontSize,
        fontColor:b.style.color,
        fontFamily:b.style.fontFamily,
        fontWeight:b.style.fontWeight,
        fontStyle:b.style.fontStyle,
        textDecoration:b.style.textDecoration,
        textAlign:b.style.textAlign
      }));
    }

    function loadLayout(){
      const data=JSON.parse(localStorage.getItem('builderLayout')||'[]');
      data.forEach(item=>{
        createLabel(item.text,item.x,item.y);
        const b=document.querySelectorAll('.label-box').pop();
        Object.assign(b.style,{
          fontSize:item.fontSize,fontFamily:item.fontFamily,
          color:item.fontColor,fontWeight:item.fontWeight,
          fontStyle:item.fontStyle,textDecoration:item.textDecoration,
          textAlign:item.textAlign
        });
      });
    }

    document.getElementById('canvasContainer').addEventListener('mousedown',e => {
      if(!e.target.classList.contains('label-box') && !e.target.classList.contains('resizer')){
        document.querySelectorAll('.label-box').forEach(b=>{
          b.classList.remove('selected');
          b.querySelector('.resizer').style.display='none';
        });
        selectedElement=null;
      }
    });

  </script>
</body>
</html>
